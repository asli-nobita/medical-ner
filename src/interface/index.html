<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Medical NER - Human-in-the-Loop Interface</title>
    <style>
        * { box-sizing: border-box; margin: 0; padding: 0; }
        
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background-color: #f5f5f5;
            line-height: 1.6;
            padding: 20px;
        }
        
        .container {
            max-width: 1200px;
            margin: 0 auto;
            background-color: white;
            padding: 30px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        
        h1 {
            color: #2c3e50;
            text-align: center;
            margin-bottom: 30px;
        }
        
        .loading {
            text-align: center;
            padding: 40px;
            color: #7f8c8d;
        }
        
        .error {
            background-color: #e74c3c;
            color: white;
            padding: 15px;
            border-radius: 5px;
            margin: 10px 0;
        }
        
        .success {
            background-color: #27ae60;
            color: white;
            padding: 15px;
            border-radius: 5px;
            margin: 10px 0;
        }
        
        /* Carousel Container */
        .carousel-container {
            position: relative;
            width: 100%;
            overflow: hidden;
            margin: 20px 0;
        }
        
        .carousel-wrapper {
            display: flex;
            transition: transform 0.4s ease-in-out;
        }
        
        .carousel-slide {
            min-width: 100%;
            padding: 0 10px;
        }
        
        /* Page Image */
        .page-image-container {
            text-align: center;
            margin-bottom: 20px;
            background-color: #f8f9fa;
            padding: 15px;
            border-radius: 8px;
            border: 2px solid #dee2e6;
        }
        
        .page-image {
            max-width: 100%;
            height: auto;
            max-height: 600px;
            border-radius: 5px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }
        
        .image-loading {
            color: #7f8c8d;
            padding: 40px;
            font-style: italic;
        }
        
        .image-error {
            color: #e74c3c;
            padding: 20px;
            font-style: italic;
        }
        
        /* Page Header */
        .page-header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 15px 20px;
            border-radius: 8px;
            margin-bottom: 20px;
            font-size: 1.3em;
            font-weight: bold;
        }
        
        /* Field Groups */
        .field-group {
            background-color: #f8f9fa;
            padding: 15px;
            margin: 15px 0;
            border-radius: 8px;
            border-left: 4px solid #3498db;
        }
        
        .field-group h3 {
            color: #34495e;
            margin-bottom: 15px;
        }
        
        .field-item {
            display: flex;
            align-items: center;
            margin: 10px 0;
            padding: 10px;
            background-color: white;
            border-radius: 5px;
            border: 1px solid #dee2e6;
        }
        
        .field-label {
            font-weight: bold;
            min-width: 140px;
            color: #495057;
        }
        
        .field-input {
            flex: 1;
            padding: 8px 12px;
            border: 1px solid #ced4da;
            border-radius: 4px;
            margin: 0 10px;
            font-size: 14px;
        }
        
        .field-input:focus {
            outline: none;
            border-color: #3498db;
            box-shadow: 0 0 0 3px rgba(52, 152, 219, 0.1);
        }
        
        .confidence {
            min-width: 80px;
            font-size: 0.9em;
            padding: 4px 8px;
            border-radius: 12px;
            text-align: center;
            color: white;
            font-weight: bold;
        }
        
        .confidence.high { background-color: #27ae60; }
        .confidence.medium { background-color: #f39c12; }
        .confidence.low { background-color: #e74c3c; }
        
        /* Navigation Controls */
        .carousel-controls {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin: 20px 0;
        }
        
        .nav-btn {
            padding: 12px 24px;
            background-color: #3498db;
            color: white;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 16px;
            font-weight: bold;
            transition: all 0.3s;
        }
        
        .nav-btn:hover:not(:disabled) {
            background-color: #2980b9;
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0,0,0,0.2);
        }
        
        .nav-btn:disabled {
            background-color: #95a5a6;
            cursor: not-allowed;
            opacity: 0.5;
        }
        
        /* Page Counter */
        .page-counter {
            text-align: center;
            flex: 1;
            font-size: 0.9em;
            color: #7f8c8d;
            font-weight: 500;
        }
        
        /* Action Buttons */
        .action-controls {
            text-align: center;
            margin: 30px 0;
        }
        
        .btn {
            padding: 12px 30px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 16px;
            margin: 5px;
            font-weight: bold;
            transition: all 0.3s;
        }
        
        .btn-success {
            background-color: #27ae60;
            color: white;
        }
        
        .btn-success:hover {
            background-color: #229954;
        }
        
        .btn-primary {
            background-color: #3498db;
            color: white;
        }
        
        .btn-primary:hover {
            background-color: #2980b9;
        }
        
        .btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }
        
        .status {
            text-align: center;
            margin: 10px 0;
            font-weight: bold;
            color: #34495e;
        }
        
        /* Empty Page Indicator */
        .empty-page {
            text-align: center;
            padding: 40px;
            color: #7f8c8d;
            font-style: italic;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>üè• Medical NER - Human-in-the-Loop Interface</h1>
        
        <div id="loading" class="loading">
            <p>Loading data...</p>
        </div>
        
        <div id="error" class="error" style="display: none;"></div>
        <div id="success" class="success" style="display: none;"></div>

        <div id="content" style="display: none;">
            <!-- Carousel Navigation -->
            <div class="carousel-controls">
                <button class="nav-btn" id="prevBtn" onclick="navigatePage(-1)">
                    ‚¨ÖÔ∏è Previous
                </button>
                <div class="page-counter" id="pageCounter">
                    Page 1 of 1
                </div>
                <button class="nav-btn" id="nextBtn" onclick="navigatePage(1)">
                    Next ‚û°Ô∏è
                </button>
            </div>

            <!-- Carousel Container -->
            <div class="carousel-container">
                <div class="carousel-wrapper" id="carouselWrapper">
                    <!-- Pages will be inserted here dynamically -->
                </div>
            </div>

            <!-- Action Buttons -->
            <div class="action-controls">
                <button class="btn btn-success" id="confirmBtn">‚úÖ Confirm All</button>
                <button class="btn btn-primary" id="saveCorrectionsBtn">üíæ Save Corrections</button>
            </div>
            <div class="status" id="status"></div>
        </div>
    </div>

    <script>
        let extractionData = [];
        let ocrData = [];
        let corrections = {};
        let currentPage = 0;
        let totalPages = 0;

        async function loadData() {
            try {
                const extractionResp = await fetch('/api/extraction_results');
                extractionData = await extractionResp.json();
                console.log('Extraction data:', extractionData);
                
                const ocrResp = await fetch('/api/ocr_results');
                ocrData = await ocrResp.json();
                console.log('OCR data:', ocrData);

                initializeCarousel();
                document.getElementById('loading').style.display = 'none';
                document.getElementById('content').style.display = 'block';
            } catch (error) {
                console.error('Load error:', error);
                showError('Failed to load data: ' + error.message);
            }
        }

        function initializeCarousel() {
            const wrapper = document.getElementById('carouselWrapper');
            wrapper.innerHTML = '';

            let pages = [];
            
            if (Array.isArray(extractionData)) {
                pages = extractionData;
            } else if (extractionData && extractionData.pages) {
                pages = extractionData.pages;
            } else {
                wrapper.innerHTML = '<div class="empty-page">No extraction results available.</div>';
                return;
            }

            if (pages.length === 0) {
                wrapper.innerHTML = '<div class="empty-page">No extraction results found.</div>';
                return;
            }

            totalPages = pages.length;
            
            // Create a slide for each page
            pages.forEach((page, pageIndex) => {
                const slide = createPageSlide(page, pageIndex);
                wrapper.appendChild(slide);
            });

            // Load images after all slides are in the DOM
            pages.forEach((page, pageIndex) => {
                const pageNumber = page.page || pageIndex + 1;
                loadPageImage(pageNumber, pageIndex);
            });

            currentPage = 0;
            updateCarousel();
        }

        function createPageSlide(page, pageIndex) {
            const pageNumber = page.page || pageIndex + 1;
            const slide = document.createElement('div');
            slide.className = 'carousel-slide';

            // Page Header
            const header = document.createElement('div');
            header.className = 'page-header';
            header.innerHTML = `üìÑ Page ${pageNumber}`;
            slide.appendChild(header);

            // Image Container
            const imageContainer = document.createElement('div');
            imageContainer.className = 'page-image-container';
            imageContainer.id = `image-container-${pageIndex}`;
            imageContainer.innerHTML = '<div class="image-loading">Loading image...</div>';
            slide.appendChild(imageContainer);

            // Note: Image will be loaded after slide is appended to DOM

            let hasContent = false;

            // Patient Information Section
            if (page.patient_info && Object.keys(page.patient_info).length > 0) {
                hasContent = true;
                const patientGroup = document.createElement('div');
                patientGroup.className = 'field-group';
                patientGroup.innerHTML = '<h3>üë§ Patient Information</h3>';
                
                Object.entries(page.patient_info).forEach(([key, value], index) => {
                    const field = {
                        test_name: key.charAt(0).toUpperCase() + key.slice(1),
                        value: value,
                        confidence: page.confidence_scores?.[key] || 0,
                        page: pageNumber,
                        type: 'patient_info'
                    };
                    patientGroup.appendChild(createFieldEditor(`patient_${pageNumber}_${index}`, field, 'patient'));
                });
                slide.appendChild(patientGroup);
            }

            // Test Results Section
            if (page.test_results && page.test_results.length > 0) {
                hasContent = true;
                const testGroup = document.createElement('div');
                testGroup.className = 'field-group';
                testGroup.innerHTML = '<h3>üß™ Test Results</h3>';
                
                page.test_results.forEach((test, index) => {
                    const field = {
                        ...test,
                        page: pageNumber,
                        type: 'test_result'
                    };
                    testGroup.appendChild(createFieldEditor(`test_${pageNumber}_${index}`, field, 'test'));
                });
                slide.appendChild(testGroup);
            }

            // Other Information Section
            if (page.other_fields && Object.keys(page.other_fields).length > 0) {
                hasContent = true;
                const otherGroup = document.createElement('div');
                otherGroup.className = 'field-group';
                otherGroup.innerHTML = '<h3>‚ÑπÔ∏è Other Information</h3>';
                
                Object.entries(page.other_fields).forEach(([key, value], index) => {
                    const field = {
                        test_name: key.charAt(0).toUpperCase() + key.slice(1),
                        value: value,
                        confidence: page.confidence_scores?.[key] || 0,
                        page: pageNumber,
                        type: 'other'
                    };
                    otherGroup.appendChild(createFieldEditor(`other_${pageNumber}_${index}`, field, 'other'));
                });
                slide.appendChild(otherGroup);
            }

            // Show message if no content
            if (!hasContent) {
                const emptyMsg = document.createElement('div');
                emptyMsg.className = 'empty-page';
                emptyMsg.textContent = 'No data extracted from this page.';
                slide.appendChild(emptyMsg);
            }

            return slide;
        }

        async function loadPageImage(pageNumber, pageIndex) {
            const container = document.getElementById(`image-container-${pageIndex}`);
            
            // Check if container exists
            if (!container) {
                console.warn(`Image container for page ${pageNumber} (index ${pageIndex}) not found in DOM`);
                return;
            }
            
            try {
                const response = await fetch(`/api/images/${pageNumber}`);
                
                if (response.ok) {
                    const blob = await response.blob();
                    const imageUrl = URL.createObjectURL(blob);
                    
                    container.innerHTML = `<img src="${imageUrl}" alt="Page ${pageNumber}" class="page-image">`;
                } else {
                    container.innerHTML = '<div class="image-error">Image not available</div>';
                }
            } catch (error) {
                console.error(`Error loading image for page ${pageNumber}:`, error);
                if (container) {
                    container.innerHTML = '<div class="image-error">Failed to load image</div>';
                }
            }
        }

        function createFieldEditor(index, field, fieldType) {
            const fieldItem = document.createElement('div');
            fieldItem.className = 'field-item';

            const label = document.createElement('div');
            label.className = 'field-label';
            label.textContent = field.test_name || field.field_name || `Field ${index}`;

            const input = document.createElement('input');
            input.className = 'field-input';
            input.value = field.value || '';
            
            if (field.unit) {
                input.placeholder = `Unit: ${field.unit}`;
            }
            
            input.onchange = () => trackCorrection(index, field, input.value, fieldType);

            const confidence = document.createElement('div');
            confidence.className = 'confidence';
            
            let confValue = field.confidence || 0;
            if (confValue > 1) {
                confValue = confValue / 100;
            }
            
            confidence.textContent = `${(confValue * 100).toFixed(1)}%`;
            
            if (confValue >= 0.7) confidence.classList.add('high');
            else if (confValue >= 0.4) confidence.classList.add('medium');
            else confidence.classList.add('low');

            fieldItem.appendChild(label);
            fieldItem.appendChild(input);
            fieldItem.appendChild(confidence);
            return fieldItem;
        }

        function trackCorrection(index, originalField, newValue, fieldType) {
            const correctionKey = `${fieldType}_${index}`;
            corrections[correctionKey] = {
                original: originalField,
                corrected_value: newValue,
                field_type: fieldType,
                page: originalField.page,
                timestamp: new Date().toISOString()
            };
        }

        function navigatePage(direction) {
            const newPage = currentPage + direction;
            
            if (newPage >= 0 && newPage < totalPages) {
                currentPage = newPage;
                updateCarousel();
            }
        }

        function updateCarousel() {
            const wrapper = document.getElementById('carouselWrapper');
            const offset = -currentPage * 100;
            wrapper.style.transform = `translateX(${offset}%)`;

            // Update page counter
            document.getElementById('pageCounter').textContent = 
                `Page ${currentPage + 1} of ${totalPages}`;

            // Update button states
            document.getElementById('prevBtn').disabled = currentPage === 0;
            document.getElementById('nextBtn').disabled = currentPage === totalPages - 1;
        }

        // Keyboard navigation
        document.addEventListener('keydown', (e) => {
            if (e.key === 'ArrowLeft') {
                navigatePage(-1);
            } else if (e.key === 'ArrowRight') {
                navigatePage(1);
            }
        });

        async function saveCorrections() {
            try {
                document.getElementById('saveCorrectionsBtn').disabled = true;
                showStatus('Saving corrections...');

                const payload = {
                    corrections: corrections,
                    extraction_results: extractionData,
                    ocr_results: ocrData,
                    timestamp: new Date().toISOString()
                };

                const response = await fetch('/api/save_corrections', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });

                const result = await response.json();
                
                if (response.ok) {
                    showSuccess(`Corrections saved: ${result.path}`);
                    corrections = {};
                } else {
                    throw new Error(result.error || 'Failed to save');
                }
            } catch (error) {
                showError('Failed to save corrections: ' + error.message);
            } finally {
                document.getElementById('saveCorrectionsBtn').disabled = false;
            }
        }

        function showError(message) {
            const errorDiv = document.getElementById('error');
            errorDiv.textContent = message;
            errorDiv.style.display = 'block';
            document.getElementById('success').style.display = 'none';
            setTimeout(() => errorDiv.style.display = 'none', 5000);
        }

        function showSuccess(message) {
            const successDiv = document.getElementById('success');
            successDiv.textContent = message;
            successDiv.style.display = 'block';
            document.getElementById('error').style.display = 'none';
            setTimeout(() => successDiv.style.display = 'none', 3000);
        }

        function showStatus(message) {
            document.getElementById('status').textContent = message;
        }

        document.getElementById('confirmBtn').onclick = () => showSuccess('All extractions confirmed!');
        document.getElementById('saveCorrectionsBtn').onclick = saveCorrections;

        window.onload = loadData;
    </script>
</body>
</html>
